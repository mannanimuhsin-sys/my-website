<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Madrasa Student System</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
    body{background:#eef3f7;font-family:'Poppins', sans-serif;padding:15px}
    .container{max-width:580px;margin:auto}
    .switch{display:flex;background:white;border-radius:20px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.15);margin-bottom:20px} 
    .switch button{flex:1;padding:14px;border:none;font-weight:600;background:#eee;cursor:pointer} 
    .switch .active{background:#198754;color:white}

    .card{background:white;padding:26px;border-radius:22px;box-shadow:0 12px 30px rgba(0,0,0,.15);border-top:8px solid #198754;margin-bottom:20px} 
    label{font-weight:600;margin-top:12px;display:block} 
    input,select{width:100%;padding:11px;border-radius:12px;border:1px solid #ccc;margin-top:4px;box-sizing: border-box;} 
    button.submit{background:#198754;color:white;border:none;padding:13px;border-radius:12px;width:100%;font-weight:600;margin-top:18px;cursor:pointer}

    .upload{border:2px dashed #198754;padding:18px;border-radius:14px;text-align:center;margin-top:8px;cursor:pointer;background:#f9fffb}

    #idCardSection{display:none;margin-top:25px;text-align:center} 
    .idCard{background:white;padding:22px;border-radius:22px;border:3px solid #198754;max-width:400px;margin:auto;box-shadow:0 12px 25px rgba(0,0,0,.18)} 
    .studentPhoto{width:140px;height:140px;border-radius:50%;border:4px solid #198754;object-fit:cover;margin-top:12px} 

    /* ID No ഒറ്റ വരിയിൽ ആക്കാനുള്ള CSS */
    .nameBox{background:#f3fff9;padding:12px;border-radius:14px;margin:12px 0;border:1px solid #198754} 
    .nameBox h2{color:#198754;margin:0;font-size:18px;font-weight:700;text-transform: uppercase;} 
    .nameBox span{font-weight:700;color:#333;display:block;margin-top:4px; font-size: 15px;} 

    .details{text-align:left;font-size:15px;line-height:1.7;color:#222;background:#fafafa;padding:14px;border-radius:14px;font-weight:600} 
    .qrBox{text-align:center;margin-top:15px; padding-top:10px; border-top: 1px dashed #ccc;} 
    .qrBox img{width:85px; display: block; margin: 0 auto 5px;} 
    .qrBox small{display:block; font-size:11px; color:#666;}

    .badgeHeader{background:linear-gradient(135deg,#198754,#20c997);color:white;padding:16px;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.25);margin-bottom:18px;text-align:center} 
    .badgeHeader h3{margin:0;font-size:16px;font-weight:700} 
    .badgeHeader small{font-size:11px}

    /* Cropper Modal */
    #cropperModal{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center;}
    .cropper-container-box{background:white; padding:15px; border-radius:15px; max-width:90%;}
    #cropImgPreview{max-width:100%; max-height:350px; display:block;}
    .field-gap{margin-bottom:12px}
</style>
</head>
<body>

<div class="container" id="mainBox">
    <div class="switch">
        <button id="loginBtn" class="active" onclick="showLogin()">LOGIN</button>
        <button id="regBtn" onclick="showRegister()">REGISTER</button>
    </div>

    <div class="card" id="loginBox">
        <div style="text-align:center;margin-bottom:10px;font-weight:700;color:#198754;">LOGIN TO VIEW ID CARD</div>
        <label>Contact Number</label>
        <input type="tel" id="lPhone" placeholder="Enter Number">
        <label>Password</label> 
        <input type="number" id="lPass" placeholder="Enter Password">
        <button class="submit" onclick="login()">Login & View ID Card</button>
    </div>

    <div class="card" id="registerBox" style="display:none">
        <div style="text-align:center;margin-bottom:10px;font-weight:700;color:#198754;">STUDENT REGISTRATION</div>
        
        <div class="field-gap"><label>Student Name</label><input id="rName"></div>
        <div class="field-gap"><label>Register Number</label><input id="rNumber" placeholder="Eg: 1023"></div>
        <div class="field-gap"><label>Date of Birth</label><input type="date" id="rDob"></div>
        
        <div class="field-gap"><label>Gender</label>
            <select id="rGender"><option value="">Select</option><option>Male</option><option>Female</option></select>
        </div>

        <div class="field-gap"><label>Blood Group</label>
            <select id="rBlood" onchange="this.value=='Other'?rBloodOther.style.display='block':rBloodOther.style.display='none'">
                <option value="">Select</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option><option>Other</option>
            </select>
            <input type="text" id="rBloodOther" style="display:none; margin-top:5px" placeholder="If Other, write here">
        </div>

        <div class="field-gap"><label>Class</label><input id="rClass"></div>
        <div class="field-gap"><label>Father’s Name</label><input id="rFather"></div>
        <div class="field-gap"><label>Mentor Name</label><input id="rMentor"></div>
        <div class="field-gap"><label>Contact Number</label><input id="rPhone"></div>
        <div class="field-gap"><label>Password</label><input type="number" id="rPass"></div>
        <div class="field-gap"><label>Confirm Password</label><input type="number" id="rcPass"></div>
        
        <div class="field-gap"><label>Profile Photo</label>
            <div class="upload" onclick="rPhoto.click()" id="uploadBtnText">Choose & Crop Photo</div>
            <input type="file" id="rPhoto" hidden accept="image/*">
        </div>
        
        <button class="submit" id="regSubmitBtn" onclick="register()">Submit Registration</button>
    </div>
</div>

<div id="idCardSection">
    <div class="idCard" id="cardBox">
        <div class="badgeHeader">
            <h3>MISBAHUL ULOOM MADRASA PERUVANA</h3>
            <small>Under-SKIMVB Reg.No:4224 | Ph:7559950633</small>
        </div>
        <img class="studentPhoto" id="pImg">
        <div class="nameBox">
            <h2 id="pName"></h2>
            <span>ID No: <b id="pNum"></b></span> </div>
        <div class="details" id="pData"></div>
        <div class="qrBox">
            <img id="qrImg">
            <small>Scan QR for Website Info</small>
        </div>
    </div>
    <button class="submit" onclick="downloadCard()">Download ID Card</button> 
    <button class="submit" onclick="location.reload()" style="background:#555">Back</button>
</div>

<div id="cropperModal">
    <div class="cropper-container-box">
        <img id="cropImgPreview">
        <button class="submit" onclick="startCrop()">Apply Crop</button>
        <button class="submit" onclick="closeCropper()" style="background:#d9534f; margin-top:5px;">Cancel</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===== FIREBASE CONFIG =====
firebase.initializeApp({
    apiKey:"AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
    authDomain:"misbahul-uloom-madrasa-4830c.firebaseapp.com",
    projectId:"misbahul-uloom-madrasa-4830c"
});
const db=firebase.firestore();
const IMGBB_API="a0ec42450bb0e87699896f33dbd7c471";

let cropper;
let croppedBlob;

function showLogin(){loginBox.style.display="block";registerBox.style.display="none";loginBtn.classList.add("active");regBtn.classList.remove("active")}
function showRegister(){loginBox.style.display="none";registerBox.style.display="block";regBtn.classList.add("active");loginBtn.classList.remove("active")}

// ===== CROPPER LOGIC =====
rPhoto.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = () => {
            cropImgPreview.src = reader.result;
            cropperModal.style.display = 'flex';
            if(cropper) cropper.destroy();
            cropper = new Cropper(cropImgPreview, { aspectRatio: 1, viewMode: 1 });
        };
        reader.readAsDataURL(file);
    }
};

function startCrop() {
    const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
    canvas.toBlob((blob) => {
        croppedBlob = blob;
        uploadBtnText.innerText = "Photo Ready ✅";
        uploadBtnText.style.borderColor = "#198754";
        cropperModal.style.display = 'none';
    }, 'image/jpeg', 0.9);
}

function closeCropper() { cropperModal.style.display = 'none'; rPhoto.value = ""; }

// ===== REGISTER (FULL DATA) =====
async function register(){
    if(!croppedBlob) return alert("Please select and crop a photo");
    if(rPass.value !== rcPass.value) return alert("Passwords not matching");

    const btn = document.getElementById("regSubmitBtn");
    btn.innerText = "Processing...";
    btn.disabled = true;

    try {
        const f=new FormData();
        f.append("image", croppedBlob);
        const res=await fetch("https://api.imgbb.com/1/upload?key="+IMGBB_API,{method:"POST",body:f});
        const imgData=await res.json();

        await db.collection("students").add({
            name: rName.value,
            number: rNumber.value,
            dob: rDob.value,
            gender: rGender.value,
            blood: rBlood.value==="Other"?rBloodOther.value:rBlood.value,
            class: rClass.value,
            father: rFather.value,
            mentor: rMentor.value,
            phone: rPhone.value,
            password: rPass.value,
            photo: imgData.data.url,
            time: Date.now()
        });

        alert("Registration Successful!");
        location.reload();
    } catch(err) {
        alert("Upload Error! Try again.");
        btn.innerText = "Submit Registration";
        btn.disabled = false;
    }
}

// ===== LOGIN & DISPLAY ID =====
async function login(){
    const s=await db.collection("students")
    .where("phone","==",lPhone.value)
    .where("password","==",lPass.value).limit(1).get();

    if(s.empty) return alert("Invalid Login!");

    const u=s.docs[0].data();
    mainBox.style.display="none";
    idCardSection.style.display="block";

    pImg.src=u.photo;
    pName.innerText=u.name;
    pNum.innerText=u.number;
    
    // ഐഡി കാർഡിലെ മുഴുവൻ വിവരങ്ങളും ഇവിടെ കാണിക്കും
    pData.innerHTML=`
    DOB : ${u.dob}<br>
    Gender : ${u.gender}<br>
    Blood : ${u.blood || "N/A"}<br>
    Class : ${u.class}<br>
    Father : ${u.father}<br>
    Mentor : ${u.mentor}<br>
    Contact : ${u.phone}
    `;
    
    qrImg.src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://mannanimuhsin-sys.github.io/my-website/index_5.html";
}

function downloadCard(){
    html2canvas(cardBox, { scale: 3 }).then(c=>{
        const link=document.createElement("a");
        link.href=c.toDataURL("image/png");
        link.download=pName.innerText+"_ID.png";
        link.click();
    });
}
</script>
</body>
</html>