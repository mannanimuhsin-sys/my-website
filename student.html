<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Madrasa Student System | Official</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
    body{background:#eef3f7;font-family:'Poppins', sans-serif;padding:15px;margin:0;}
    .container{max-width:580px;margin:auto}

    /* SWITCH BUTTON */
    .switch{display:flex;background:white;border-radius:20px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.15);margin-bottom:20px} 
    .switch button{flex:1;padding:14px;border:none;font-weight:600;background:#eee;cursor:pointer} 
    .switch .active{background:#198754;color:white}

    /* CARDS & FORMS */
    .card{background:white;padding:26px;border-radius:22px;box-shadow:0 12px 30px rgba(0,0,0,.15);border-top:8px solid #198754;margin-bottom:20px} 
    label{font-weight:600;margin-top:12px;display:block} 
    input,select{width:100%;padding:11px;border-radius:12px;border:1px solid #ccc;margin-top:4px;box-sizing: border-box;} 
    button.submit{background:#198754;color:white;border:none;padding:15px;border-radius:12px;width:100%;font-weight:600;margin-top:18px;cursor:pointer; transition: 0.3s;}
    button.submit:hover{background: #146c43;}

    .upload{border:2px dashed #198754;padding:18px;border-radius:14px;text-align:center;margin-top:8px;cursor:pointer;background:#f9fffb}
    .field-gap{margin-bottom:12px}

    /* EXECUTIVE ID CARD DESIGN - ADJUSTED PHOTO POSITION */
    #idCardSection{display:none;margin-top:25px;text-align:center; padding-bottom: 50px;}
    
    .idCard {
        background: white;
        width: 380px; 
        margin: 0 auto;
        border-radius: 25px;
        overflow: hidden;
        box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        border: 1px solid #ddd;
        position: relative;
    }

    .badgeHeader {
        background: linear-gradient(135deg, #198754, #20c997);
        color: white;
        padding: 25px 15px 60px; /* ഫോട്ടോയ്ക്ക് സ്ഥലം നൽകാൻ താഴെ പാഡിംഗ് കൂട്ടി */
    }
    .badgeHeader h3 { margin: 0; font-size: 17px; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
    .badgeHeader small { display: block; margin-top: 5px; font-size: 11px; opacity: 0.9; }

    .photo-holder {
        margin-top: -55px; /* ഫോട്ടോ കൃത്യമായി ഹെഡിംഗിന് താഴെ വരാൻ അഡ്ജസ്റ്റ് ചെയ്തു */
        position: relative;
        z-index: 2;
    }
    .studentPhoto {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        border: 5px solid white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        object-fit: cover;
        background: white;
    }

    .nameBox {
        padding: 10px 10px 5px;
    }
    .nameBox h2 { color: #198754; margin: 0; font-size: 22px; font-weight: 700; text-transform: uppercase; }
    .nameBox span { display: inline-block; background: #e8f5e9; color: #1b5e20; padding: 4px 15px; border-radius: 20px; font-size: 15px; font-weight: 700; margin-top: 8px; border: 1px solid #c8e6c9; }

    .details-table {
        text-align: left;
        padding: 15px 25px;
        background: #fff;
    }
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f1f1;
        font-size: 14px;
    }
    .info-label { color: #777; font-weight: 600; }
    .info-value { color: #222; font-weight: 700; text-align: right; }

    .qr-footer {
        background: #fdfdfd;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-top: 2px dashed #eee;
    }
    .qr-footer img { width: 75px; height: 75px; }
    .footer-text { text-align: left; line-height: 1.4; color: #666; font-size: 10px; font-weight: 600; }

    /* CROPPER MODAL */
    #cropperModal{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; flex-direction:column;}
    .crop-container{background:white; padding:15px; border-radius:15px; max-width:90%;}
</style>
</head>
<body>

<div class="container" id="mainBox">
    <div class="switch">
        <button id="loginBtn" class="active" onclick="showLogin()">LOGIN</button>
        <button id="regBtn" onclick="showRegister()">REGISTER</button>
    </div>

    <div class="card" id="loginBox">
        <div style="text-align:center;margin-bottom:15px;font-weight:700;color:#198754;">LOGIN TO VIEW ID CARD</div>
        <label>Contact Number</label>
        <input type="tel" id="lPhone" placeholder="Enter number">
        <label>Password</label> 
        <input type="password" id="lPass" placeholder="Enter password">
        <button class="submit" onclick="login()">Open My ID Card</button>
    </div>

    <div class="card" id="registerBox" style="display:none">
        <div style="text-align:center;margin-bottom:15px;font-weight:700;color:#198754;">STUDENT REGISTRATION</div>
        <div class="field-gap"><label>Student Name</label><input id="rName"></div>
        <div class="field-gap"><label>Register Number</label><input id="rNumber"></div>
        <div class="field-gap"><label>Date of Birth</label><input type="date" id="rDob"></div>
        <div class="field-gap"><label>Gender</label>
            <select id="rGender"><option value="">Select</option><option>Male</option><option>Female</option></select>
        </div>
        <div class="field-gap"><label>Blood Group</label>
            <select id="rBlood" onchange="this.value=='Other'?rBloodOther.style.display='block':rBloodOther.style.display='none'">
                <option value="">Select</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option><option>Other</option>
            </select>
            <input type="text" id="rBloodOther" style="display:none; margin-top:5px" placeholder="Specify Blood Group">
        </div>
        <div class="field-gap"><label>Class</label><input id="rClass"></div>
        <div class="field-gap"><label>Father's Name</label><input id="rFather"></div>
        <div class="field-gap"><label>Mentor Name</label><input id="rMentor"></div>
        <div class="field-gap"><label>Contact Number</label><input id="rPhone"></div>
        <div class="field-gap"><label>Password</label><input type="password" id="rPass"></div>
        <div class="field-gap"><label>Confirm Password</label><input type="password" id="rcPass"></div>
        <div class="field-gap">
            <label>Profile Photo</label>
            <div class="upload" onclick="rPhoto.click()" id="uploadBtnText">Click to Select & Crop Photo</div>
            <input type="file" id="rPhoto" hidden accept="image/*">
        </div>
        <button class="submit" id="regSubmitBtn" onclick="register()">Submit Registration</button>
    </div>
</div>

<div id="idCardSection">
    <div class="idCard" id="cardBox">
        <div class="badgeHeader">
            <h3>MISBAHUL ULOOM MADRASA PERUVANA</h3>
            <small>Under-SKIMVB Reg.No:4224 | Ph:7559950633</small>
        </div>
        
        <div class="photo-holder">
            <img class="studentPhoto" id="pImg">
        </div>

        <div class="nameBox">
            <h2 id="pName"></h2>
            <span>ID NO: <b id="pNum"></b></span>
        </div>

        <div class="details-table">
            <div class="info-row"><span class="info-label">DOB</span><span class="info-value" id="pDob"></span></div>
            <div class="info-row"><span class="info-label">Gender</span><span class="info-value" id="pGender"></span></div>
            <div class="info-row"><span class="info-label">Blood Group</span><span class="info-value" id="pBlood"></span></div>
            <div class="info-row"><span class="info-label">Class</span><span class="info-value" id="pClass"></span></div>
            <div class="info-row"><span class="info-label">Father's Name</span><span class="info-value" id="pFather"></span></div>
            <div class="info-row"><span class="info-label">Mentor Name</span><span class="info-value" id="pMentor"></span></div>
            <div class="info-row" style="border:none;"><span class="info-label">Contact</span><span class="info-value" id="pPhone"></span></div>
        </div>

        <div class="qr-footer">
            <div class="footer-text">OFFICIAL STUDENT ID<br>MISBAHUL ULOOM MADRASA<br>PERUVANA, KERALA</div>
            <img id="qrImg">
        </div>
    </div>
    
    <div style="max-width:380px; margin: 20px auto;">
        <button class="submit" onclick="downloadCard()">Download High Quality PNG</button> 
        <button class="submit" onclick="location.reload()" style="background:#555">Logout / Back</button>
    </div>
</div>

<div id="cropperModal">
    <div class="crop-container">
        <img id="cropImgPreview" style="max-width:100%;">
        <button class="submit" onclick="startCrop()">Apply Crop & Save</button>
        <button class="submit" onclick="closeCropper()" style="background:#d32f2f; margin-top:5px;">Cancel</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ===== FIREBASE =====
firebase.initializeApp({
    apiKey:"AIzaSyBriz_0zYwQOcwVgd3XTQ0l-0NKBNYaZXQ",
    authDomain:"misbahul-uloom-madrasa-4830c.firebaseapp.com",
    projectId:"misbahul-uloom-madrasa-4830c"
});
const db = firebase.firestore();
const IMGBB_API = "a0ec42450bb0e87699896f33dbd7c471";

let cropper;
let croppedBlob;

function showLogin(){loginBox.style.display="block";registerBox.style.display="none";loginBtn.classList.add("active");regBtn.classList.remove("active")}
function showRegister(){loginBox.style.display="none";registerBox.style.display="block";regBtn.classList.add("active");loginBtn.classList.remove("active")}

rPhoto.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = () => {
            cropImgPreview.src = reader.result;
            cropperModal.style.display = 'flex';
            if(cropper) cropper.destroy();
            cropper = new Cropper(cropImgPreview, { aspectRatio: 1, viewMode: 1 });
        };
        reader.readAsDataURL(file);
    }
};

function startCrop() {
    const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
    canvas.toBlob((blob) => {
        croppedBlob = blob;
        uploadBtnText.innerText = "Photo Ready ✅";
        uploadBtnText.style.borderColor = "#198754";
        cropperModal.style.display = 'none';
    }, 'image/jpeg', 0.9);
}

function closeCropper() { cropperModal.style.display = 'none'; rPhoto.value = ""; }

async function register(){
    if(!croppedBlob) return alert("Please select and crop a photo");
    if(rPass.value !== rcPass.value) return alert("Passwords mismatch!");
    const btn = document.getElementById("regSubmitBtn");
    btn.innerText = "Processing..."; btn.disabled = true;
    try {
        const f=new FormData(); f.append("image", croppedBlob);
        const res = await fetch("https://api.imgbb.com/1/upload?key="+IMGBB_API, {method:"POST", body:f});
        const img = await res.json();
        await db.collection("students").add({
            name: rName.value,
            number: rNumber.value,
            dob: rDob.value,
            gender: rGender.value,
            blood: rBlood.value === "Other" ? rBloodOther.value : rBlood.value,
            class: rClass.value,
            father: rFather.value,
            mentor: rMentor.value,
            phone: rPhone.value,
            password: rPass.value,
            photo: img.data.url,
            time: Date.now()
        });
        alert("Registration Success!"); location.reload();
    } catch(err) { alert("Error!"); btn.disabled = false; }
}

async function login(){
    const s = await db.collection("students")
        .where("phone","==",lPhone.value)
        .where("password","==",lPass.value).limit(1).get();
    if(s.empty) return alert("Wrong Credentials!");
    const u = s.docs[0].data();
    document.getElementById("mainBox").style.display = "none";
    document.getElementById("idCardSection").style.display = "block";
    document.getElementById("pImg").src = u.photo;
    document.getElementById("pName").innerText = u.name;
    document.getElementById("pNum").innerText = u.number;
    document.getElementById("pDob").innerText = u.dob;
    document.getElementById("pGender").innerText = u.gender;
    document.getElementById("pBlood").innerText = u.blood || "N/A";
    document.getElementById("pClass").innerText = u.class;
    document.getElementById("pFather").innerText = u.father;
    document.getElementById("pMentor").innerText = u.mentor || "N/A";
    document.getElementById("pPhone").innerText = u.phone;
    document.getElementById("qrImg").src = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + encodeURIComponent(window.location.href);
}

function downloadCard() {
    const card = document.getElementById("cardBox");
    html2canvas(card, {
        scale: 3,
        useCORS: true,
        backgroundColor: null,
        width: 380,
        windowWidth: 380
    }).then(canvas => {
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png", 1.0);
        link.download = document.getElementById("pName").innerText + "_ID.png";
        link.click();
    });
}
</script>
</body>
</html>